# ğŸš€ å½»åº•ææ‡‚ WebSocket æ¡æ‰‹å…¨è¿‡ç¨‹ä¸å®æˆ˜å¼€å‘æŒ‡å—

åœ¨ç°ä»£ Web åº”ç”¨ä¸­ï¼Œå®æ—¶é€šä¿¡å·²æˆä¸ºæ ‡é…ã€‚æ— è®ºæ˜¯èŠå¤©å®¤ã€åœ¨çº¿åä½œã€è‚¡ç¥¨è¡Œæƒ…æ¨é€ï¼Œè¿˜æ˜¯ç‰©è”ç½‘è®¾å¤‡ç›‘æ§ï¼ˆå¦‚å……ç”µæ¡© OCPP åè®®ï¼‰ï¼Œ**WebSocket** éƒ½æ˜¯å®ç°å…¨åŒå·¥é€šä¿¡çš„æ ¸å¿ƒæŠ€æœ¯ã€‚

ä½†ä½ æ˜¯å¦çœŸæ­£ç†è§£è¿‡ï¼š  
> **ä¸ºä»€ä¹ˆ WebSocket èƒ½â€œå‡çº§â€HTTPï¼Ÿ**  
> **`Sec-WebSocket-Accept` æ˜¯æ€ä¹ˆç®—å‡ºæ¥çš„ï¼Ÿ**  
> **`Opcode=3` åˆ°åº•åˆä¸åˆæ³•ï¼Ÿ**

æœ¬æ–‡å°†å¸¦ä½ æ·±å…¥ WebSocket åè®®åº•å±‚ï¼Œä»æ¡æ‰‹æŠ¥æ–‡åˆ°æ•°æ®å¸§ç»“æ„ï¼Œå†åˆ°å®é™…å¼€å‘æŠ€å·§ï¼Œ**æ‰‹æŠŠæ‰‹æ•™ä½ æ„å»ºä¸€ä¸ªå®‰å…¨ã€ç¨³å®šã€å¯æ‰©å±•çš„ WebSocket æœåŠ¡**ã€‚

---

## 1. WebSocket æ˜¯ä»€ä¹ˆï¼Ÿä¸ºä»€ä¹ˆå®ƒèƒ½â€œæ‰“ç ´â€HTTP çš„é™åˆ¶ï¼Ÿ

### 1.1 HTTP çš„â€œè¯·æ±‚-å“åº”â€æ¨¡å¼ç“¶é¢ˆ

ä¼ ç»Ÿçš„ HTTP åè®®æ˜¯â€œä¸€é—®ä¸€ç­”â€å¼çš„ï¼šå®¢æˆ·ç«¯å‘è¯·æ±‚ â†’ æœåŠ¡å™¨å›å“åº” â†’ è¿æ¥å…³é—­ã€‚è¿™ç§æ¨¡å¼åœ¨éœ€è¦**å®æ—¶æ¨é€**çš„åœºæ™¯ä¸‹æ˜¾å¾—åŠ›ä¸ä»å¿ƒã€‚

ä¾‹å¦‚ï¼š  
- èŠå¤©åº”ç”¨ä¸­ï¼Œç”¨æˆ· A å‘æ¶ˆæ¯ï¼Œç”¨æˆ· B å¿…é¡»ä¸æ–­è½®è¯¢æœåŠ¡å™¨æ‰èƒ½çœ‹åˆ°ã€‚
- å……ç”µæ¡©çŠ¶æ€å˜åŒ–ï¼Œåå°ç®¡ç†ç³»ç»Ÿæ— æ³•ç«‹å³æ„ŸçŸ¥ã€‚

è¿™å°±æ˜¯æ‰€è°“çš„â€œ**é•¿è½®è¯¢**â€æˆ–â€œ**Comet**â€æŠ€æœ¯ï¼Œæ•ˆç‡ä½ã€å»¶è¿Ÿé«˜ã€æµªè´¹èµ„æºã€‚

### 1.2 WebSocketï¼šä¸€æ¬¡æ¡æ‰‹ï¼Œç»ˆç”Ÿå¯¹è¯

WebSocket çš„æ ¸å¿ƒæ€æƒ³æ˜¯ï¼š  
> **åˆ©ç”¨ HTTP å®Œæˆâ€œèº«ä»½éªŒè¯â€ï¼ˆæ¡æ‰‹ï¼‰ï¼Œç„¶åâ€œè„±å£³â€å˜æˆç‹¬ç«‹çš„åŒå‘é€šä¿¡åè®®ã€‚**

å®ƒé€šè¿‡ä¸€ä¸ªç‰¹æ®Šçš„ **HTTP åè®®å‡çº§æœºåˆ¶ï¼ˆUpgrade: websocketï¼‰**ï¼Œå°†åŸæœ¬çŸ­æš‚çš„ HTTP è¿æ¥â€œå‡çº§â€ä¸ºæŒä¹…çš„ã€å…¨åŒå·¥çš„ WebSocket è¿æ¥ã€‚

#### 1.2.1 å…³é”®ä¼˜åŠ¿

| ç‰¹æ€§ | HTTP | WebSocket |
|------|------|-----------|
| é€šä¿¡æ¨¡å¼ | å•å‘ï¼ˆè¯·æ±‚â†’å“åº”ï¼‰ | åŒå‘ï¼ˆå®¢æˆ·ç«¯â‡„æœåŠ¡ç«¯ï¼‰ |
| è¿æ¥çŠ¶æ€ | çŸ­è¿æ¥ | é•¿è¿æ¥ |
| å»¶è¿Ÿ | é«˜ï¼ˆéœ€é¢‘ç¹å»ºç«‹è¿æ¥ï¼‰ | ä½ï¼ˆå·²å»ºç«‹ï¼‰ |
| å¼€é”€ | æ¯æ¬¡è¯·æ±‚å¸¦å®Œæ•´å¤´éƒ¨ | å¸§å¤´æå°ï¼ˆ2~14å­—èŠ‚ï¼‰ |

---

## 2. æ­ç§˜ WebSocket æ¡æ‰‹ï¼šä» HTTP åˆ° WebSocket çš„â€œå˜èº«ä»ªå¼â€

WebSocket çš„è¿æ¥å§‹äºä¸€æ¬¡æ ‡å‡†çš„ HTTP è¯·æ±‚ï¼Œä½†å®ƒçš„ç›®çš„ä¸æ˜¯è·å–èµ„æºï¼Œè€Œæ˜¯**è¯·æ±‚åè®®å‡çº§**ã€‚

### 2.1 å®¢æˆ·ç«¯å‘èµ·æ¡æ‰‹è¯·æ±‚

å®¢æˆ·ç«¯å‘é€ä¸€ä¸ªå¸¦æœ‰ç‰¹æ®Šå¤´éƒ¨çš„ HTTP è¯·æ±‚ï¼š

```http
GET /ocpp/cp001 HTTP/1.1
Host: server.example.com
Upgrade: websocket
Connection: Upgrade
Sec-WebSocket-Key: dGhlIHNhbXBsZSBub25jZQ==
Sec-WebSocket-Version: 13
Sec-WebSocket-Protocol: ocpp1.6, json
Origin: https://dashboard.example.com
```

#### 2.1.1 å…³é”®å­—æ®µè§£æ

| å­—æ®µ | ä½œç”¨ |
|------|------|
| `Upgrade: websocket` | å‘Šè¯‰æœåŠ¡å™¨ï¼šâ€œæˆ‘æƒ³å‡çº§åˆ° WebSocket åè®®â€ |
| `Connection: Upgrade` | é…åˆ `Upgrade`ï¼Œè¡¨ç¤ºè¿™æ˜¯ä¸€ä¸ªåè®®åˆ‡æ¢è¯·æ±‚ |
| `Sec-WebSocket-Key` | å®¢æˆ·ç«¯ç”Ÿæˆçš„éšæœº Base64 å­—ç¬¦ä¸²ï¼ˆå¦‚ `dGhlIHNhbXBsZSBub25jZQ==`ï¼‰ï¼Œç”¨äºé˜²ç¯¡æ”¹éªŒè¯ |
| `Sec-WebSocket-Version: 13` | æŒ‡å®š WebSocket åè®®ç‰ˆæœ¬ï¼ˆRFC 6455ï¼‰ |
| `Sec-WebSocket-Protocol: ocpp1.6` | å¯é€‰å­åè®®ï¼Œå¸¸ç”¨äºå……ç”µæ¡©ï¼ˆOCPPï¼‰ã€é‡‘èã€æ¸¸æˆç­‰åœºæ™¯ |

> ğŸ’¡ `Sec-WebSocket-Key` æ˜¯å®¢æˆ·ç«¯éšæœºç”Ÿæˆçš„ï¼Œ**ä¸æ˜¯å¯†é’¥**ï¼Œè€Œæ˜¯ç”¨äºé˜²æ­¢ç¼“å­˜ä»£ç†è¯¯åˆ¤ã€‚

---

### 2.2 æœåŠ¡ç«¯å“åº”ï¼šåŒæ„å‡çº§

å¦‚æœæœåŠ¡å™¨æ”¯æŒ WebSocketï¼Œå®ƒä¼šè¿”å›ä¸€ä¸ª `101 Switching Protocols` å“åº”ï¼š

```http
HTTP/1.1 101 Switching Protocols
Upgrade: websocket
Connection: Upgrade
Sec-WebSocket-Accept: s3pPLMBiTxaQ9kYGzzhZRbK+xOo=
Sec-WebSocket-Protocol: ocpp1.6
Server: workerman/4.1.17
```

#### 2.2.1 `Sec-WebSocket-Accept` çš„ç”ŸæˆåŸç†

è¿™æ˜¯æ¡æ‰‹éªŒè¯çš„æ ¸å¿ƒï¼æœåŠ¡å™¨å¿…é¡»æ ¹æ®å®¢æˆ·ç«¯çš„ `Sec-WebSocket-Key` è®¡ç®—å‡ºæ­£ç¡®çš„ `Sec-WebSocket-Accept`ã€‚

##### 2.2.1.1 è®¡ç®—æ­¥éª¤

1. å–å®¢æˆ·ç«¯çš„ `Sec-WebSocket-Key`ï¼š  
   `dGhlIHNhbXBsZSBub25jZQ==`

2. æ‹¼æ¥å›ºå®š GUIDï¼š  
   `dGhlIHNhbXBsZSBub25jZQ==258EAFA5-E914-47DA-95CA-C5AB0DC85B11`

3. å¯¹æ‹¼æ¥ç»“æœè¿›è¡Œ SHA-1 å“ˆå¸Œï¼š  
   `sha1("dGhlIHNhbXBsZSBub25jZQ==258EAFA5-E914-47DA-95CA-C5AB0DC85B11")`

4. å°†å“ˆå¸Œç»“æœè¿›è¡Œ Base64 ç¼–ç ï¼š  
   `s3pPLMBiTxaQ9kYGzzhZRbK+xOo=`

> âœ… è¿™ä¸ªå€¼å¿…é¡»å®Œå…¨åŒ¹é…ï¼Œå¦åˆ™å®¢æˆ·ç«¯ä¼šæ‹’ç»è¿æ¥ã€‚

#### 2.2.2 å­åè®®åå•†ï¼š`Sec-WebSocket-Protocol`

å®¢æˆ·ç«¯å¯ä»¥æä¾›å¤šä¸ªå­åè®®ï¼ˆå¦‚ `ocpp1.6, json, v10.stomp`ï¼‰ï¼ŒæœåŠ¡å™¨é€‰æ‹©å…¶ä¸­ä¸€ä¸ªè¿”å›ã€‚  
è¿™ç›¸å½“äºï¼šâ€œæˆ‘ä»¬æ¥ä¸‹æ¥ç”¨ **OCPP 1.6 åè®®** æ¥é€šä¿¡â€ã€‚

---

### 2.3 æ¡æ‰‹æˆåŠŸï¼è¿›å…¥ WebSocket é€šä¿¡é˜¶æ®µ

ä¸€æ—¦å®¢æˆ·ç«¯æ”¶åˆ°æ­£ç¡®çš„ `101` å“åº”ï¼Œ**HTTP åè®®å°±æ­¤ç»“æŸ**ï¼ŒTCP è¿æ¥è¢«â€œæ¥ç®¡â€ä¸º WebSocket è¿æ¥ï¼Œåç»­æ‰€æœ‰æ•°æ®éƒ½ä»¥ **WebSocket å¸§ï¼ˆFrameï¼‰** çš„å½¢å¼ä¼ è¾“ã€‚

---

## 3. WebSocket æ•°æ®å¸§ï¼šè½»é‡é«˜æ•ˆçš„é€šä¿¡å•å…ƒ

æ¡æ‰‹å®Œæˆåï¼Œé€šä¿¡ä¸å†ä½¿ç”¨ HTTP æŠ¥æ–‡ï¼Œè€Œæ˜¯ä½¿ç”¨ WebSocket è‡ªå®šä¹‰çš„**äºŒè¿›åˆ¶å¸§ç»“æ„**ã€‚

### 3.1 å¸§ç»“æ„è¯¦è§£

ä¸€ä¸ª WebSocket å¸§ç”±å¤šä¸ªå­—æ®µç»„æˆï¼Œæœ€å°ä»… 2 å­—èŠ‚ï¼š

```
  0                   1                   2                   3
  0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1 2 3 4 5 6 7 8 9 0 1
 +-+-+-+-+-------+-+-------------+-------------------------------+
 |F|R|R|R| opcode|M| Payload len |    Extended payload length    |
 |I|S|S|S|  (4)  |A|     (7)     |             (16/64)           |
 |N|V|V|V|       |S|             |   (if payload len==126/127)   |
 | |1|2|3|       |K|             |                               |
 +-+-+-+-+-------+-+-------------+ - - - - - - - - - - - - - - - +
 |     Extended payload length continued, if payload len == 127  |
 + - - - - - - - - - - - - - - - +-------------------------------+
 |                               |Masking-key, if MASK set to 1  |
 +-------------------------------+-------------------------------+
 | Masking-key (continued)       |          Payload Data         |
 +-------------------------------- - - - - - - - - - - - - - - - +
 :                     Payload Data continued ...                :
 + - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - +
 |                     Payload Data continued ...                |
 +---------------------------------------------------------------+
```

### 3.2 å…³é”®å­—æ®µè¯´æ˜

| å­—æ®µ | è¯´æ˜ |
|------|------|
| `FIN` | æ˜¯å¦æ˜¯æ¶ˆæ¯çš„æœ€åä¸€ä¸ªå¸§ï¼ˆ1=æ˜¯ï¼Œ0=å¦ï¼‰ |
| `Opcode` | å¸§ç±»å‹ï¼ˆè§ä¸‹è¡¨ï¼‰ |
| `Mask` | æ˜¯å¦æ©ç ï¼ˆå®¢æˆ·ç«¯â†’æœåŠ¡ç«¯å¿…é¡»ä¸º1ï¼‰ |
| `Payload len` | æœ‰æ•ˆè½½è·é•¿åº¦ï¼ˆ7/16/64ä½ï¼‰ |
| `Masking-key` | 4å­—èŠ‚æ©ç å¯†é’¥ï¼ˆç”¨äºé˜²ç¼“å­˜æ”»å‡»ï¼‰ |
| `Payload Data` | å®é™…æ•°æ®ï¼ˆæ–‡æœ¬æˆ–äºŒè¿›åˆ¶ï¼‰ |

### 3.3 `Opcode`ï¼šå¸§ç±»å‹çš„â€œèº«ä»½è¯â€

`Opcode` æ˜¯ 4 ä½å­—æ®µï¼Œå®šä¹‰å¸§çš„ç±»å‹ï¼š

| Opcode (Hex) | åç§° | è¯´æ˜ |
|--------------|------|------|
| `0x0` | Continuation | è¿ç»­å¸§ï¼ˆç”¨äºåˆ†ç‰‡æ¶ˆæ¯ï¼‰ |
| `0x1` | Text | UTF-8 æ–‡æœ¬å¸§ |
| `0x2` | Binary | äºŒè¿›åˆ¶å¸§ |
| `0x8` | Close | å…³é—­è¿æ¥ |
| `0x9` | Ping | å¿ƒè·³æ£€æµ‹ |
| `0xA` | Pong | å¯¹ Ping çš„å“åº” |
| `0x3` ~ `0x7`, `0xB` ~ `0xF` | ä¿ç•™ | **æœªå®šä¹‰ï¼Œä¸å¯ç”¨** |

> âŒ **é‡ç‚¹ï¼š`Opcode = 3` æ˜¯éæ³•çš„ï¼**  
> å®ƒä¸åœ¨ RFC 6455 æ ‡å‡†ä¸­ï¼Œä»»ä½• WebSocket å®ç°éƒ½ä¸åº”ä½¿ç”¨æˆ–æ¥å—å®ƒã€‚å¦‚æœä½ åœ¨æŠ“åŒ…ä¸­çœ‹åˆ° `Opcode=3`ï¼Œå¾ˆå¯èƒ½æ˜¯åè®®å®ç°é”™è¯¯æˆ–è‡ªå®šä¹‰æ‰©å±•ï¼ˆä¸æ¨èï¼‰ã€‚

---

## 4. å®æˆ˜å¼€å‘ï¼šå¦‚ä½•å®‰å…¨ã€é«˜æ•ˆåœ°å¯¹æ¥ WebSocket æœåŠ¡

### 4.1 é€‰æ‹©åˆé€‚çš„å¼€å‘æ¡†æ¶ï¼ˆåˆ«å†æ‰‹åŠ¨ç®— `Sec-WebSocket-Accept`ï¼ï¼‰

ä½ **ä¸éœ€è¦**æ‰‹åŠ¨å®ç°æ¡æ‰‹é€»è¾‘ï¼ç°ä»£æ¡†æ¶å·²å¸®ä½ æå®šã€‚

#### 4.1.1 æ¨èæ¡†æ¶

| è¯­è¨€ | æ¡†æ¶ | ç‰¹ç‚¹ |
|------|------|------|
| Node.js | `ws` | è½»é‡ã€é«˜æ€§èƒ½ |
| Python | `websockets` | å¼‚æ­¥å‹å¥½ |
| PHP | `Workerman` | ä½ çœ‹åˆ°çš„ `workerman/4.1.17` å°±æ˜¯å®ƒ |
| Java | `Spring WebSocket` | ä¼ä¸šçº§é›†æˆ |
| Go | `gorilla/websocket` | é«˜å¹¶å‘ |

#### 4.1.2 ç¤ºä¾‹ï¼šNode.js + `ws` å¿«é€Ÿæ­å»ºæœåŠ¡å™¨

```javascript
const WebSocket = require('ws');

const wss = new WebSocket.Server({ port: 8080 });

wss.on('connection', (ws, req) => {
  console.log('New client connected');
  
  // æ¥æ”¶æ¶ˆæ¯
  ws.on('message', (data) => {
    console.log('Received:', data.toString());
    
    // å›å¤
    ws.send('Echo: ' + data);
  });

  // å®¢æˆ·ç«¯å…³é—­
  ws.on('close', () => {
    console.log('Client disconnected');
  });
});
```

### 4.2 å®‰å…¨æœ€ä½³å®è·µ

#### 4.2.1 ä½¿ç”¨ WSSï¼ˆWebSocket Secureï¼‰

```url
wss://server.example.com/chat
```
> ç›¸å½“äº HTTPSï¼Œé€šè¿‡ TLS åŠ å¯†é€šä¿¡ã€‚

#### 4.2.2 éªŒè¯ `Origin` é˜²æ­¢ CSRF

```javascript
wss.on('connection', (ws, req) => {
  const origin = req.headers.origin;
  if (!isValidOrigin(origin)) {
    ws.close(1008, 'Origin not allowed');
    return;
  }
});
```

#### 4.2.3 å­åè®®ä¸è®¤è¯

```http
# å®¢æˆ·ç«¯è¯·æ±‚
Sec-WebSocket-Protocol: ocpp1.6
Authorization: Bearer <token>
```

> æœåŠ¡ç«¯éªŒè¯ token åˆæ³•æ€§åå†æ¥å—è¿æ¥ã€‚

---

## 5. æ€»ç»“ï¼šWebSocket å¼€å‘æ ¸å¿ƒè¦ç‚¹

| è¦ç‚¹ | è¯´æ˜ |
|------|------|
| âœ… æ¡æ‰‹æ˜¯ HTTP å‡çº§ | ä½¿ç”¨ `Upgrade: websocket` å’Œ `101` å“åº” |
| âœ… `Sec-WebSocket-Accept` è‡ªåŠ¨å¤„ç† | ç”±æ¡†æ¶è®¡ç®—ï¼Œæ— éœ€æ‰‹åŠ¨å®ç° |
| âœ… `Opcode=3` æ˜¯éæ³•çš„ | åªèƒ½ä½¿ç”¨ `0x0`~`0xA` ä¸­çš„æ ‡å‡†å€¼ |
| âœ… ä½¿ç”¨å­åè®®ï¼ˆå¦‚ `ocpp1.6`ï¼‰ | æå‡åè®®å¯è¯»æ€§å’Œæ‰©å±•æ€§ |
| âœ… ä¼˜å…ˆä½¿ç”¨ WSS | ä¿è¯é€šä¿¡å®‰å…¨ |
| âœ… é€‰æ‹©æˆç†Ÿæ¡†æ¶ | é¿å…é‡å¤é€ è½®å­ |

---

## é™„å½•ï¼šå®Œæ•´æ¡æ‰‹æµç¨‹å›¾

```
å®¢æˆ·ç«¯                          æœåŠ¡ç«¯
  |                               |
  |--- HTTP GET + Upgrade Header -->|
  |                               |
  |<-- HTTP 101 + Sec-WebSocket-Accept ---|
  |                               |
  |======= WebSocket è¿æ¥å»ºç«‹ =======|
  |                               |
  |<-------- Text/Binary Frame ----|
  |---- Pong (å¯¹ Ping çš„å“åº”) --->|
  |                               |
  |<------- Close Frame (0x8) -----|
  |---- Close Frame (0x8) ------>|
  |                               |
  === è¿æ¥å…³é—­ ===
```

æŒæ¡ WebSocketï¼Œä½ å°±èƒ½æ„å»ºçœŸæ­£çš„å®æ—¶åº”ç”¨ã€‚ç°åœ¨ï¼Œå°±å»è¯•è¯•å§ï¼ ğŸ’ª
