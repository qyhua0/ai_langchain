# 八年半的坚守与热爱：一个“像孩子一样”的新能源汽车充电桩平台成长记

今天是2025年10月30日，距离我正式结束连续8年5个月的职业生涯仅剩不到24小时。回望从2017年6月1日至今的这段旅程，我参与过无数项目，但有一个项目始终在我心中占据特殊位置——它就像我亲手养育的孩子，从无到有，从稚嫩到成熟，每一段代码、每一次优化、每一个深夜的调试，都倾注了我最深的情感与坚持。

这个项目，就是“新能源汽车充电桩平台”。

## 一、从0到1：在混沌中孕育希望

项目最初诞生于**广东XX云计算有限公司**。彼时，新能源汽车尚处于市场培育期，充电基础设施建设刚刚起步。我们的客户主要使用深圳某公司生产的充电桩，品牌为**晶福源**。项目启动之初，我几乎独自承担了所有核心模块的设计与开发：从设备接入、协议解析、订单管理，到运营后台、用户小程序，每一行关键代码都由我亲手编写。

然而，现实远比想象复杂。晶福源提供的充电协议文档存在大量模糊、矛盾甚至错误之处。例如，关于VIN码充电的逻辑描述不清，导致我们无法准确识别车辆身份；电量上报格式不规范，造成计费异常；充电开始/结束时间戳错乱；SOC（电池剩余电量）数值跳变……这些问题在初期几乎每天都在挑战我们的耐心与技术底线。

最难忘的一次，我们不得不亲自前往桩厂，与对方技术团队面对面逐条核对协议细节，现场调试、抓包、复现问题。那几天的讨论虽然艰苦，却为后续稳定运行打下了坚实基础。

更棘手的是，在项目上线后不久，该桩企突然停止技术支持，甚至逐渐退出市场。面对“断供”的现实，我们别无选择——只能通过软件层进行兜底处理。例如：

- 对桩上传的电量报文进行智能分段校正，避免因多段电量错位导致计费错误；
- 动态修正充电起止时间偏差；
- 对异常SOC值进行平滑滤波与逻辑校验；
- 针对价格下发错误的桩，增加二次校验与回滚机制，防止用户“超充”损失。

正是这些“软性补丁”，让平台在硬件不可控的情况下依然保障了客户业务的连续性与用户体验。

## 二、百花齐放：多品牌接入与生态扩展

随着项目口碑积累，越来越多的桩企主动寻求接入。我们陆续支持了**追日、中研、科陆、科华、光烨、车电网、英飞源、科士达、易事特、万城万充**等数十个主流品牌。平台也从最初仅服务**公交车充电场景**，逐步扩展至**社会车辆公共充电网络**。

与此同时，我们开始对接各大第三方互联互通平台，包括：
- **小桔充电**
- **蚂蚁充电（新电途）**
- **槽操充电（省级平台）**

这一阶段，平台成功保障了**广东某市全域公交充电系统的稳定运行**，并支撑了大量社会新能源车主的日常出行，真正成为城市绿色交通的“数字底座”。

## 三、架构演进：稳与快的平衡之道

在第一家公司，我们对技术架构进行了深思熟虑的选型。面对“既要稳定又要快速迭代”的双重压力，最终决定采用 **Spring Boot 微服务架构**，并构建了清晰的分层体系：

- **底层（Base Layer）**：封装公司多年积累的通用工具类、基础依赖，作为所有项目的“技术资产”。
- **公共层（Common Layer）**：提供跨服务共享的模型、数据库操作封装（MyBatis）、Redis 缓存工具、通用业务逻辑等。
- **微服务层（Microservices）**：
  - 各品牌设备 TCP 接入服务（基于 Netty）
  - 协议解析服务
  - 订单与计费服务
  - 运营管理平台
  - 小程序后端服务
  - 第三方平台对接服务（小桔、新电途等）
  - 定时任务与数据延迟处理服务
- **服务注册与发现中心**：用于服务监控与负载均衡调度。
- **前端**：采用 Vue.js 开发，通过 Nginx 部署，与常规 Web 项目一致。

特别值得一提的是，**设备接入层基于 Netty 实现高并发通信**。初期我们直接使用 Netty 的标准解码器处理报文，但随着接入桩型增多，发现不同厂商的报文格式存在大量“非标”现象。为此，我们重构了解析逻辑，引入**正则表达式动态匹配机制**，并妥善处理了 TCP 粘包/拆包问题。最终，我们为每个品牌（如晶福源、云快充、广汽埃安等）独立部署专属微服务，实现“隔离故障、互不影响”的高可用设计。

### 技术栈亮点：
- **Spring Boot 2.x**：兼顾开发效率与运行性能；
- **MyBatis**：支持快速开发，复杂查询可手写 SQL 优化；
- **消息队列**：从 ActiveMQ 迁移至 **阿里 RocketMQ**，不仅性能跃升，还规避了早期 ActiveMQ 的安全漏洞；
- **缓存体系**：结合 **Google Guava Cache + Redis**，实现多级缓存策略；
- **无网关设计**：出于对稳定性的极致追求，我们**未引入微服务网关**。理由很明确：网关一旦故障，将波及所有服务。而我们每个微服务均已实现完整的**接口请求日志记录**，足以支撑问题追踪与审计，无需统一入口带来的额外风险。

## 四、部署架构与数据流转：从物理隔离到高效协同

技术架构的优秀，离不开合理的部署策略与清晰的数据流转路径。在两家公司不同阶段，我们根据业务规模与资源条件，设计了针对性的部署方案。

### 第一家公司（广东XX云计算）：高可用双机热备 + 流水线式处理

客户提供了三台服务器，形成“测试-生产”双轨机制：

- **测试服务器（1台）**：部署全套服务（含数据库），所有代码更新必须先在此环境验证通过，方可上线正式环境，确保生产稳定性。
- **正式服务器（2台高配）**：
  - 配置均为 **32GB 内存、8核 CPU、100GB 系统盘**，其中一台额外配备 **800GB 数据盘**，用于存储海量充电日志与原始报文。

#### 服务器1：前置机（Frontend Gateway）
- **核心职责**：直面海量充电桩的 TCP 长连接。
- **部署内容**：
  - 各品牌设备 TCP 接入微服务（如晶福源、追日、科陆等独立服务）
  - RocketMQ 消息中间件（Broker + NameServer）
- **数据流转**：
  - 桩端上行报文 → Netty 服务接收 → **立即写入 RocketMQ 上行队列**（保障低延迟响应）
  - 下行指令（如启停充电、价格下发）由业务服务生成 → 写入 RocketMQ 下行队列 → 前置机消费并实时下发至桩
- **设计目标**：确保在万级并发连接下，报文接收与响应无卡顿、无丢失。

#### 服务器2：业务处理中心（Backend Processor）
- **部署内容**：
  1. **主数据库**（MySQL，高可用配置）
  2. **多个协议解析服务实例**（当前运行3个）：负责消费上行队列，解析协议，执行业务逻辑（如生成订单、校验电量、计算费用）。关键操作（如数据库写入）再通过队列异步传递给订单服务，形成“**TCP接入 → 协议解析 → 订单处理**”的高速流水线。
  3. **订单服务、运营管理后台、定时任务服务**等核心业务模块
- **高可用策略**：协议解析服务部署多个实例，支持**滚动更新**——更新时逐个重启，确保至少有一个实例始终在线，充电业务零中断。

整个系统通过 RocketMQ 实现**解耦与削峰填谷**，即使在高峰期，也能平稳处理突发流量。

### 第二家公司（东莞XX物联网）：轻量化SaaS部署

进入SaaS产品化阶段后，公司自有机房资源有限，采用两台 **16GB 内存、4核 CPU** 的服务器。由于客户规模较小、数据量不及前期市政项目，我们对部署做了简化但保持逻辑清晰：

- **服务器A**：专用于**桩企侧服务**，部署桩接入、协议解析、订单等全套微服务；
- **服务器B**：专用于**互联互通平台**，包含对接小桔、新电途、省级平台的API服务及运营后台；
- 两台服务器各自独立运行完整服务栈（含数据库与消息队列），逻辑隔离，互不影响，便于多租户场景下的权限与数据管理。

虽然硬件规格降低，但得益于架构的模块化与SaaS化改造，系统依然保持高内聚、低耦合的特性，支撑了浙江项目及后续多客户并行运营。

## 五、涅槃重生：从项目到SaaS产品的跨越

2021年10月31日，因疫情冲击与公司经营调整，广东XX云计算有限公司的充电桩项目被迫终止。幸运的是，在前同事的邀请下，我于**2021年11月1日加入东莞市XX物联网科技有限公司**，继续守护这个“孩子”。

新公司不仅承接了原有平台的运维，还迅速启动了**浙江省某市的同类项目**。基于已有架构，我们仅用极短时间就完成了基于**云快充协议**的新平台上线，并成功对接当地互联互通平台。

此后，项目迎来关键转型——**从定制化项目升级为标准化SaaS产品**。我们陆续接入：
- **广汽埃安自建桩**
- **欧洲标准 OCPP 1.6 协议桩**

在这一过程中，我们对架构进行了产品化重构：

### SaaS化改造重点：
1. **多租户支持**：原系统仅支持单一桩企、多商家；SaaS版实现**多桩企、多运营商、多租户**并行；
2. **服务解耦**：取消原有独立的小程序微服务，将其能力下沉至公共API层；
3. **互联互通平台产品化**：
   - 新增 **桩企API接入服务**（Vue管理页面）
   - 构建 **互联运营平台后台**
   - 提供 **小程序API服务** 与 **互联互通微信小程序**
   - 抽象出 **公共服务包** 与 **基础依赖模块**，提升复用率。

### 技术再升级：
- 消息队列从 RocketMQ 迁移至 **RabbitMQ**。这一选择并非盲目跟风，而是看中其**虚拟主机（vhost）天然支持数据隔离**的特性——完美契合 SaaS 多租户场景下的安全与资源隔离需求。实践证明，RabbitMQ 在高并发、可靠性与运维友好性上表现卓越，堪称 SaaS 平台的理想搭档。

## 六、终章：一份完整的SaaS充电平台交付

历经八年半的打磨、两家公司的接力、无数次协议适配与架构迭代，**2025年，我们终于交付了一套完整、稳定、可扩展的 SaaS 新能源汽车充电平台**。它不仅支持数十家桩企的无缝接入，还能灵活对接各类互联互通生态，真正实现了“桩-平台-用户-运营商”全链路打通。

如今，平台已在多家客户现场稳定运行，日均处理充电订单数万笔，支撑着城市绿色出行的脉搏。

## 写在最后

明天，我将告别这段职业生涯。但这个项目，早已超越“工作”的范畴——它是我的技术信仰、工程美学与职业精神的结晶。每一行代码背后，都是对细节的执着、对用户的负责、对行业的热爱。

感谢所有曾并肩作战的同事，感谢那些“不讲武德”的桩企协议，感谢深夜服务器告警时的清醒与坚持。正是这些点滴，铸就了今天的成果。

愿这个平台继续生长，服务更多城市、更多车主；也愿每一位工程师，都能拥有一个“像孩子一样”的项目，倾注心血，见证成长。

—— 2025年10月30日 · 于职业生涯终点前夜
